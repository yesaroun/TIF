8.3 인그레스의 세부 기능: annotation을 이용한 설정

이전에 Ingress를 생성할 때, 주석(annotation) 항목에서 몇 가지를 설정했떤 것을 기억할 것이다. Ingress는 YAML 파일의 주석 항목을 정의함으로써 다양한 옵션을 사용할 수 있따. 이전에 사용해봤던 주석 항목을 다시 살펴보겠다.

```yml
apiVersion: netwoking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-example
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  spec:
...
```

주석 이름에서 알 수 있듯이 이 주석은 Nginx Ingress Controller에서만 사용할 수 있는 기능이다. 이 주석은 인그레스에 정의된 경로로 들어오는 요청을 rewrite-target에 설정된 경로로 전달한다. 예를 들어, Nginx Ingress Controller로 `/echo-hostname`으로 접근하면 `hostname-service`에는 `/` 경로로 전달된다.

```yml
...
    nginx.ingress.kubernetes.io/rewrite-target: /  # [2] hostname-service의 / 로 전달된다.
...
      paths:
      - path: /echo-hostname  # [1] /ehco-hostname 경로로 들어온 요청은
...
```

단, rewrite-target은 `/echo-hostname`이라는 경로로 시작하는 모든 요청을 hostname-service의 / 로 전달한다. 예를 들어 `/echo-hostname/alice/bob`이라는 경로로 요청을 보내도 똑같이 `/`로 전달된다.

```bash
$ curl http://a91008ce...ap-northeast-2.elb.amazonaws.com/echo-hostname/alice/bob
---
You accessed to path "/"
Access Server URL : http://a91008ceb90...ap-northeast-2.elb.amazonaws.com/
Container HOstname : hostname-deployment-6c5c6885c-rn7n6
Container IP : 192.168.1.252
---
```

사실 rewrite-target은 Nginx의 Captured groups와 함께 사용할 때 유용한 기능이다. Captured Groups란 정규 표현시그이 형태로 요청 경로 등의 값을 변수로서 사용할 수 있는 방법이다. 기존에 사용해봤던 Ingress를 다음과 같이 변경해보겠다.

예제8.4 chapter8/ingress-rewrite-target-k8s-latest.yaml

```yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-example
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2  # path의 (.*) 에서 획득한 경로로 전달한다.
spec:
  ingressClassName: nginx
  rules:
  - host: <여러분이 Nginx Controller에 접근하기 위한 도메인 이름을 입력합니다>
  #- host: a2cbfefcfbc...-19761.ap-northeast-2.elb.amazonaws.com
    http:
      paths:
      - path: /echo-hostname(/|$)(.*)  # (.*) 을 통해 경로를 얻는다.
        pathType: ImplementationSpecific
        backend:
          service:
            name: hostname-service
            port:
              number: 80
```

```bash
$ kubectl apply -f ingress-rewrite-target-k8s-latest.yaml
ingress.extensions/ingress-example onfigured
```

path 항목에서 `(.*)` 이라는 Nginx의 정규 표현식을 통해 `/echo-hostname/` 뒤에 오는 경로를 얻은 뒤, 이 값을 `rewrite-target`에서 사용한 것뿐이다. 예를 들어 `/echo-hostname/color/red`는 `/color/red`로 전달된다. 즉, 요청 경로를 다시 쓰는(rewrite) 것이라고 이해면 쉽다.

```bash
$ curl http://a91008ceb90...ap-northeast-2.elb.amazonaws.com/echo-hostname/color/red
---
You accessed to path "/color/red"
```

그 외의 루트 경로(`/`)로 접근했을 때 특정 path로 리다이렉트하는 app-root 주석이나 SSL 리다이렉트를 위한 ss-redirect 주석 등을 사용할 수 있다. Nginx Ingress Controller에서 사용할 수 있는 주석은 공식 사이트에서 확인할 수 있다. 그 외의 Ingress Controller 공식 문서를 참고해 다른 서버의 기능도 사용할 수 있다.

