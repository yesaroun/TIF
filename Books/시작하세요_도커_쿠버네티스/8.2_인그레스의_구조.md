8.2 Ingress의 구조

`kubectl get ingress` 명령어로 Ingress의 목록을 확인할 수 있다.

```bash
$ kubectl get ingress
$ kubectl get ing  # ing라는 이름으로도 사용 가능
No resources found.
```

간단한 Ingress를 생성해보겠다.

예제 8.1 chapter8/ingress-example-k8s-latest.yaml

```yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-example
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: alicek106.example.com  # [1]
    http:
      paths:
      - path: /echo-hostname  # [2]
        pathType: Prefix
        backend:
          service:
            name: hostname-service  # [3]
            port:
              number: 80
```

[1] host: 해당 도메인 이름으로 접근하는 요청에 대해 처리 규칙을 적용한다. 위 예시는 alicek106.example.com 이라는 도메인으로 접근하는 요청만 처리하지만, 여러 개의 host를 정의해 사용할 수도 있다.
[2] path: 해당 경로에 들어온 요청을 어느 서비스로 전달할 것인지 정의한다. 위 예시에서는 `/echo-hostname`이라는 경로의 요청을 bakcend에 정의된 서비스로 전달한다. 여러 개의 path를 정의해 경로를 처리할 수도 있다.
[3] name, port: path로 들어온 요청이 전달될 서비스와 포트이다. 즉 위 예시에서는 `/echo-hostname`이라는 경로로 들어온 요청을 hostname-service 서비스의 80 포트로 전달한다.

```bash
$ kubectl apply -f ingress-example-k8s-latest.yaml
ingress.networking.k8s.io/ingress-example created

$ kubectl get ingress
NAME            CLASS   HOSTS                   ADDRESS     PORTS       AGE
ingress-example nginx   alicek106.example.come              80          6s
```

ingress-example이라는 이름의 Ingress를 생성했지만, 이것만으로는 아무 일도 일어나지 않는다. Ingress는 단지 요청을 처리하는 규칙을 정의하는 선언적인 Object일뿐, 외부 요청을 받아들일 수 있는 실제 서비스가 아니기 때문이다. Ingress는 Ingress Controller 라고 하는 특수한 서버에 적용해야지만 그 규칙을 사용할 수 있다. 즉, 실제로 외부 요청을 받아들이는 것은 Ingress Controller Server이며, 이 Server가 Ingress 규칙을 로드해 사용한다.

따라서 Kubernetes의 Ingress는 반드시 Ingress Controller라는 서버와 함께 사용해야 한다. Ingress Controller Server는 여러 종류가 있으면 필요에 따라 하나를 골라 사용하면 된다. 대표적으로는 Nginx Web Server Ingress Controller가 있다. 그 외에도 Konge 이라는 API GateWay나 GKE 등의 Cloud Platform에서 제공되는 Ingress Controller가 있지만, 이번 장에는 Nginx Ingress Controller를 사용해 보겠다.

Nginx Ingress Controller는 Kubernetes에서 공식적으로 개발되고 있기 때문에 설치를 위한 YAML 파일을 공식 Github에서 직접 내려받을 수 있다. 아래 명령어를 실행하면 Nginx Ingress Controller와 관련된 모든 리소스를 한 번에 설치할 수 있다.

```bash
$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.1/deploy/static/provider/cloud/deploy.yaml

namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
```

명령어의 출력 결과에서 알 수 있듯이 Nginx Ingress Controller를 설치하기 위해 다양한 Kubernetes 리소스를 한 번에 생성한다. ingress-nginx 라는 Namespace에 Nginx Web Server Deployment를 생성하고, 그와 관련된 설정들을 Configmap으로 생성하는 것을 알 수 있다.

시간이 지난 뒤 ingress-nginx Namespace의 Deployment와 Pod를 확인해보면 Nginx Web Server가 생성돼 있을 것이다.

```bash
$ kubectl get pods, deployment -n ingress-nginx
NAME                                        READY   STATUS      RESTARTS    AGE
pod/ingress-nginx-admission-create-kx22l    0/1     Completed   0           23m
pod/ingress-nginx-admission-pathc-zn9l7     0/1     Completed   0           23m
pod/ingress-nginx-controller-6653jf-l382    1/1     Running     0           23m

NAME                                        READY   UP-TO-DATE  AVAILABLE   AGE
deployment.apps/ingress-nginx-controller    1/1     1           1           23mA
```

외부에서 Nginx Ingress Controller에 접근하기 위한 Service도 생성됐을 것이다.

```bash
$ kubectl get svc
NAME                                TYPE            CLUSTER-IP      EXTERNAL-IP                 ...
ingress-nginx-controller            LoadBalancer    100.66.64.61    a20..2.elb.amazonaws.com    ...
ingress-nginx-controller-admission  ClusterIP       100.71.133.142  ...
```

Nginx Ingress Controller를 설치하면 자동으로 생성되는 Service는 LoadBalancer 타입이며, 위 예시는 AWS에서 생성된 예시이다. 실제 운영 환경이라면 LoadBalancer Type에 DNS 이름을 할당함으로써 Nginx Ingress Controller에 접근하는 것이 일반적이지만 일단 지금은 자동으로 부여된 DNS 이름(a20..2.elb.amazonaws.com)을 사용해 보겠다.

하지만 가상 머신처럼 Cloud가 아닌 환경에서 Ingress를 테스트하고 싶다면 LoadBalancer 대신 NodePort Type의 Service를 생성해 사용해도 된다. 이 경우에는 각 Node의 Random한 Port로 Nginx Ingress Controller에 접근할 수 있다.

예제 8.2 chapter8/ingress-nginx-svc-nodeport.yaml

p355









































