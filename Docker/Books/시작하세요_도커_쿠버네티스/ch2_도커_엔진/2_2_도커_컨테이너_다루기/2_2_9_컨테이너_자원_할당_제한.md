컨테이너를 생성하는 run, create 명령에서 컨테이너의 자원 할당량을 조정하도록 옵션을 입력할 수 있다.
아무런 옵션을 입력하지 않으면 컨테이너는 호스트의 자원을 제한 없이 쓸 수 있음
그래서 컨테이너의 자원 할당을 제한해 호스트와 다른 컨테이너의 동작을 방해하지 않게 설정하는 것이 좋다.

현재 컨테이너에 설정된 자원 제한 을 확인하는 방법: `docker inspect` 활용

```bash
docker inspect mysql
>>>
...
						"DeviceRequests": null,
            "MemoryReservation": 0,
            "MemorySwap": 0,
            "MemorySwappiness": null,
            "OomKillDisable": null,
            "PidsLimit": null,
            "Ulimits": [],
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0,
 ...
```

컨테이너 자원 제한을 변경하려면 update 명령어 사용

```bash
docker update (변경할 자원 제한) (컨테이너 이름)

docker update --cpuset-cpus=1 centos ubuntu
```

# 2.2.9.1 컨테이너 메모리 제한

`--memory` 를 지정해 컨테이너 메모리 제한할 수 있다.
단위는 m(megabyte), g(gigabyte), 최소 메모리: 6MB

- -d 옵션
    
    `-d` 옵션은 "detached" 모드를 의미. 이 옵션을 사용하면 컨테이너가 백그라운드에서 실행되어 터미널을 차지하지 않고 명령어 실행 후 바로 프롬프트로 돌아갈 수 있습니다. 주로 서버나 데몬 프로세스처럼 계속 실행되어야 하는 컨테이너를 시작할 때 사용합니다.
    

```bash
docker run -d \
--memory="1g" \
--name memory_1g \
nginx
```

```bash
docker inspect memory_1g | grep \"Memory\"
>>>
"Memory": 1073741824,
```

컨테이너 내에서 동작하는 프로세스가 컨테이너에 할당된 메모리를 초과하면 컨테이너는 자동으로 종료

기본적으로 컨테이너의 Swap 메모리는 메모리의 2배로 설정되지만 별도로 지정할 수 있다.

```bash
docker run -it --name swap_500m \
--memory=200m \
--memory-swap=500m \
ubuntu:24.04
```

# 2.2.9.2 컨테이너 CPU 제한

## `--cpu-shares`

`--cpu-shares` 옵션은 컨테이너에 가중치를 설정해 해당 컨테이너가 CPU를 상대적으로 얼마나 사용할 수있는지 나타냄
즉, 컨테이너에 CPU를 한 개씩 할당하는 방식이 아닌, 시스템에 존재하는 CPU를 어느 비중 만큼 나눠(share) 쓸 것인지를 명시하는 옵션

```bash
docker run -i -t --name cpu_share \
--cpu-shares 1024 \
ubuntu:24.04
```

`--cpu-shares` 옵션은 상대적인 값을 가진다. 아무런 설정을 하지 않았을 때 컨테이너가 가지는 값은 1024로, 이는 CPU 할당에서 1의 비중을 뜻한다.

아래처럼 1개의 CPU를 가지는 호스트에서 테스트 진행해보겠다.
`stress —cpu 1` : 1개의 프로세스로 CPU에 부하를 주는 명령어c

```bash
docker run -d --name cpu_1024 \
--cpu-shares 1024 \
alicek106/stress \
stress --cpu 1
```

cpu_1024 컨테이너의 CPU 사용률 확인

```bash
ps aux | grep stress
>>>
root   29694  0.3   0.0   7312  904 ?  Ss  15:01  0:00 stress --cpu 1
root   29738  101   0.0   7312   96 ?  R   15:01  0:10 stress --cpu 1
```

현재 호스트에 다른 컨테이너가 존재하지 않기 때문에 CPU를 100% 사용하고 있음.
`—-cpu-shares` 의 값이 512로 설정된 컨테이너 새로 생성해보겠다.

```bash
docker run -d --name cpu_512 \
--cpu-shares 512 \
alicek106/stress \
stess --cpu 1
```

시간이 충분히 CPU 사용률 확인해보면

```bash
ps aux | grep stress
>>>
root   29694   0.0   0.0   7312  904 ?  Ss  15:01  0:00 stress --cpu 1
root   29738  69.3   0.0   7312   96 ?  R   15:01  5:40 stress --cpu 1
root   29795   0.0   0.0   7312  904 ?  Ss  15:02  0:00 stress --cpu 1
root   29847  33.1   0.0   7312   96 ?  R   15:02  2:10 stress --cpu 1
```

두 컨테이너가 각각 69%, 33%의 CPU를 사용(2:1 비율) 즉, [1024 : 512 = 2 : 1] 비율대로 사용

## `--cpuset-cpus`

호스트에 CPU가 여러 개 있을 때 `--cpuset-cpus` 옵션을 지정해 컨테이너가 특정 CPU만 사용하도록 설정 할 수 있다.
cpu 집중적인 작업이 필요하다면 여러 개의 CPU를 사용하도록 설정해 작업을 적절히 분배하는 것이 좋다.
다음 예시는 컨테이너가 3번째 CPU만 사용하도록 설정

```bash
docker run -d --name cpuset_2 \
--cpuset-cpus=2 \
alicek106/stress \
stress --cpu 1
```

htop 명령어로 CPU 사용량 확인하면 3번째 CPU만 사용되는 것을 알 수 있다.

# `--cpu-period` , `--cpu-quota`

컨테이너의 CFS(Completely Fair Sceduler) 주기는 기본적으로 100 ms 로 설정되지만 run 명령어의 옵션 중 `--cpu-period` 와 `--cpu-quota` 로 이 주기를 변경할 수 있다.

```bash
docker run -d --name quota_1_4 \
--cpu-period=100000 \
--cpu-quota=25000 \
alicek106/stress \
stress --cpu 1
```

`--cpu-period` 의 값은 기본적으로 100000이며, 이는 100ms를 뜻한다. `--cpu-quota` 는 `--cpu-period` 에 설정된 시간 중 CPU 스케쥴링에 얼마나 할당할 것인지를 설정
위 예시에서 100000 중 25000 만큼 할당해 CPU 주기가 1/4로 줄었으므로 일반적인 컨테이너보다 CPU 성능이 1/4 정도로 감소

# `--cpus`

`--cpus` 옵션은 `--cpu-period` , `--cpu-quota` 와 동일한 기능을 하지만 좀 더 직관적으로 CPU 개수를 직접 지정한다는 점에서 다르다.
예를 들어 `--cpus` 옵션에서 0.5를 설정하면 `--cpu-period=100000` `--cpu-quota=5000` 와 동일하게 컨테이너의 CPU를 제한할 수 있다.

```bash
docker run -d --name cpus_container \
--cpus=0.5 \
alicek106/stress \
stress --cpu 1
```

병렬 처리를 위해 CPU를 많이 소모하는 워크로드를 수행해야 한다면 `--cpu-share`, `--cpus`, `--cpu-period` , `--cpu-quota` 옵션 보다는 `--cpuset-cpu` 옵션을 사용하는 것이 좋다.
`—-cpuset-cpu` 옵션을 사용하면 특정 컨테이너가 특정 CPU에서만 동작하는 CPU 친화성(Affinity)를 보장할 수 있고, CPU 캐시미스 또는 컨텍스트 스위칭과 같이 성능을 하락시키는 요인을 최소화할 가능성이 높아지기 때문

# Docker 컨테이너 자원 할당 제한 요약

컨테이너의 자원 할당을 제어하는 주요 방법들을 정리하겠습니다:

### 메모리 제한

- `--memory` 옵션으로 메모리 제한 (최소 6MB)
- `--memory-swap` 옵션으로 스왑 메모리 설정 가능
- 기본적으로 스왑 메모리는 할당된 메모리의 2배

### CPU 제한 방법

1. **CPU 공유 (`--cpu-shares`)**
    - 상대적 가중치 설정 (기본값 1024)
    - 다른 컨테이너와의 상대적 비율로 CPU 자원 분배
2. **CPU 코어 지정 (`--cpuset-cpus`)**
    - 특정 CPU 코어만 사용하도록 설정
    - CPU 집중적 작업에 권장되는 방식
3. **CPU 주기 설정**
    - `--cpu-period`, `--cpu-quota`: CFS 스케줄러 주기 조정
    - `--cpus`: 직관적으로 CPU 개수 지정

### 자원 확인 및 변경

- `docker inspect`: 현재 설정된 자원 제한 확인
- `docker update`: 실행 중인 컨테이너의 자원 제한 변경

### 권장사항

CPU 집중적인 워크로드의 경우 `--cpuset-cpus` 사용을 권장 (CPU 친화성 보장, 캐시 미스 감소)