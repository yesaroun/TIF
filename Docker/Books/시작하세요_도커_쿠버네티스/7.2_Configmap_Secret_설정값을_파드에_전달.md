Configmap, Secret: 설정값을 Pod에 전달(7.2)

설정값이나 설정 파일을 애플리케이션에 전달하는 가장 확실한 방법은 도커 이미지 내부에 설정값 또는 설정 파일을 정적으로 저장해 놓는 것이다. 하지만 docker image는 일단 빌드되고 나면 불변의 상태를 가지기 때문에 이 방법은 상황에 따라 설정 옵션을 유연하게 변경할 수 없다는 단점이 있다.

이에 대한 대안으로 파드를 정의하는 YAML 파일에 환경 변수를 직접 적어 놓는 하드 코딩 방식을 사용할 수도 있다. 예를 들어 deployment의 YAML 파일 중 pod template에서 아래와 같은 방식으로 환경 변수를 직접 설정할 수도 있다.

chapter7/env-hard-coding-deployment.yaml(`LOG_LEVEL` 이라는 이름의 환경 변수 설정)

```yaml
...
spec:
  containers:
  - name: nginx
    env:
    - name: LOG_LEVEL
      value: INFO
    image: nginx:1.10
...
```

만약 운영 환경과 개발 환경에서 각각 deployment를 생성해야 한다면 환경 변수가 서로 다르게 설정된 두 가지 버전의 YAML 파일이 따로 존재해야하기 때문에 문제가 될 수 있다.

Kubernetes는 YAML 파일과 설정값을 분리할 수 있는 Configmap과 Secret이라는 object를 제공한다. Configmap에는 설정값을, Secret에는 노출되어서는 안 되는 비밀값을 저장할 수 있다.

# 7.2.1 Configmap

## Configmap 사용 방법 익히기

Configmap은 일반적인 설정값을 담아 저장할 수 있는 Kubernetes object이며, namespace에 속하기 때문에 namespace 별로 Configmap이 존재한다.

YAML 파일로 생성할수도 있고, `kubectl create configmap` 명령어로도 생성할 수 있다. 예를 들어 다음 명령어는 `--from-literal` 옵션을 사용해 `LOG_LEVEL` 키의 값이 `DEBUG`인 Configmap을 생성해며, Configmap의 이름은 `log-level-configmap`이 된다.

```bash
$ kubectl create configmap <configmap name> <각종 설정값들>
$ kubectl create configmap log-level-configmap --from-literal LOG_LEVEL=DEBUG
```

또는 `--from-literal` 옵션을 여러 번 사용함으로써 여러 개의 키, 값을 configmap에서 사용하도록 설정할 수 있다. 아래의 예시는 `start-k8s`라는 이름의 configmap에 두 개의 카,값 쌍을 저장했다.

```bash
$ kubectl create configmap start-k8s --from-literal k8s=kubernetes \
    --from-literal container=docker
```

Configmap에 설정된 값은 `kubectl describe configmap` 명령어나 `kubectl get configmap -o yaml` 명령어로 확인할 수 있다.

```bash
$ kubectl get cm  # cm 이라는 이름으로도 사용 가능
$ kubectl get configmap
NAME                DATA    AGE
log-level-configmap 1       2m3s
start-k8s           2       2m5s

$ kubectl describe configmap log-level-configmap
Data
====
LOG_LEVEL:
----
DEBUG
Events:     <none>

$ kubectl get configmap log-level-configmap -o yaml
apiVersion: v1
data:
  LOG_LEVEL: DEBUG
kind: ConfigMap
```

이렇게 생성한 Configmap의 값을 파드로 가져오면 된다.

Configmap을 Pod에서 사용하는 방법은 2가지 있다.

### Configmap의 값을 Container의 환경 변수로 사용

Configmap의 값을 Pod의 Container 환경 변수로 가져온다. Configmap에 저장돤 key-value data가 Container 환경 변수의 key-value 로 그대로 사용되기 때문에 shell에서 `echo $LOG_LEVEL`과 같은 방식으로도 값을 확인할 수 있다. Application이 시스템 환경 변수로부터 설정값을 가져온다면 이 방법을 사용하는 것이 좋다.

### Configmap의 값을 Pod의 File로 Mount해 사용

Configmap의 값을 Pod Container 내부의 특정 파일로 마운트한다. 예를 들어 `LOG_LEVEL=INFO`라는 값을 가지는 Configmap을 `/etc/config/log_level`이라는 파일로 Mount하면 `log_level` 파일에 INFO라는 값이 저장된다. 이때 파일이 위치랗 경로는 별도로 설정할 수 있다. Application이 nginx.conf 등의 파일을 통해 설정값을 읽어들인다면 이 방법을 사용하는 것이 좋다.


## Configmap의 data를 Container의 환경 변수로 가져오기

첫 번째 방법으로 환경 변수를 사용하는 Pod를 생성해보겠다.

chapter7/all-env-from-configmap.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: container-env-example
spec:
  containers:
    - name: my-container
      image: busybox
      args: ['tail', '-f', '/dev/null']
      envFrom:
      - configMapRef:
          name: log-level-configmap  # key-value 쌍이 1개 존재하는 Configmap
      - configMapRef:
          name: start-k8s  # key-value 쌍이 2개 존재하는 Configmap
```

해당 파일에서 중요한 내용은 envFrom과 configMapRef 항목이다. 위에서 생성해두었던 log-level-configmap, start-k8s 두 개의 Configmap으로부터 값을 가져와 환경 변수를 생성하도록 설정했다.

YAML 파일에서 envFrom 항목은 하나의 Configmap에 여러 개의 key-value 쌍이 존재하더라도 모두 환경 변수로 가져오도록 설정한다. 따라서 start-k8s Configmap에서 2개의 key-value 데이터가 한꺼번에 Pod의 환경 변수로 등록될 것이다. 즉, 위에서 총 3개의 key-value 쌍을 Pod로 넘긴 셈이다.

Pod를 생성한 뒤 파드 내부에서 환경 변수의 목록을 출력해보겠다. env는 환경 변수를 출력하는 명령어이다.

```bash
$ kubectl apply -f all-env-from-configmap.yaml
pod/container-env-example created

$ kubectl exec container-env-example -- env
...
LOG_LEVEL=DEBUG
container=docker
k8s=kubernetes
...
```

이번에는 다른 방법으로 파드를 생성해 보겠다. 아래와 같이 valueFrom과 configMapKeyRef를 사용하면 여러 개의 key-value 쌍이 있는 Configmap에서 특정 데이터만 선택해 환경 변수로 가져올 수 있다. env 황목을 제외한 부분은 위의 YAML 파일과 동일하므로 파일의 일부분을 생략했다.

chapter7/selective-env-from-configmap.yaml

```yaml
...
env:
- name: ENV_KEYNAME_1  # (1.1) container에 새롭게 등록될 환경 변수 이름
  valueFrom:
    configMapKeyRef:
      name: log-level-configmap
      key: LOG_LEVEL
- name: ENV_KEYNAME_2  # (1.2) container에 새롭게 등록될 환경 변수 이름
  valueFrom:
    configMapKeyRef:
      name: start-k8s  # (2) 참조할 컨피그맵의 이름
      key: k8s         # (3) 가져올 데이터 값의 키
                       # 최종 결과 -> ENV_KEYNAME_2=$(k8s 키에 해당하는 값)
                       #              ENV_KEYNAME_2=kubernetes
```

```bash
$ kubectl apply -f selective-env-from-configmap.yaml
pod/container-selective-env-example created
```

(1) Pod의 Container에서 새롭게 설정될 환경 변수의 이름이다. 위 예시에서는 Pod Container 내부에서 `ENV_KEYNAME_1`과 `ENV_KEYNAME_2` 라는 두 개의 환경 변수가 존재할 것이다.

(2) 어떠한 Configmap으로부터 값을 가져올 것인지 입력한다.

(3) 해당 컨피그맵의 key-value data 중 어떠한 키의 값을 가져올 것인지 명시한다. 예를 들어 위와 같이 `key: k8s` 처럼 명시하면 `start-k8s` 컨피그맵의 `k8s` 키의 값인 kubernetes가 `ENV_KEYNAME_1` 환경 변수에 들어가게 된다.

```bash
$ kubectl exec container-selective-env-example -- env | grep ENV
ENV_KEYNAME_1=kubernetes
ENV_KEYNAME_2=DEBUGA
```

- envFrom: Configmap에 존재하는 모든 key-value 쌍을 가져온다.
- valueFrom과 configMapKeyRef: Configmap에 존재하는 key-value 쌍 중에서 원하는 데이터만 선택적으로 가져온다.

## Configmap의 내용을 파일로 파드 내부에 마운트하기

Application이 nginx.conf, mysql.confg 등 과 같은 특정 파일로부터 설정값을 읽어온다면 Configmap의 데이터를 파드 내부의 파일로 마운트해 사용할 수 있다. 예를 들어 아래의 YAML 파일은 start-k8s Configmap에 존재하는 모든 key-value 쌍을 `/etc/config` 디렉터리에 위치시킨다.

chater7/volume-mount-configmap.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: configmap-volume-pod
spec:
  containers:
    - name: my-container
      image: busybox
      args: [ "tail", "-f", "/dev/null" ]
      volumeMounts:
      - name: configmap-volume      # volumes에서 정의한 Configmap Volume 이름
        mountPath: /etc/config      # Configmap의 데이터가 위치할 경로

  volumes:
    - name: configmap-volume        # Configmap Volume 이름
      configMap:
        name: start-k8s             # key-value 쌍을 가져올 Configmap 이름
```

- spec.volumes: YAML 파일에서 사용할 볼륨의 목록을 정의한다. 위 예시에서는 `start-k8s`라는 이름의 Configmap을 통해 configmap-volume 볼륨을 정의했다. volumes 항목에서 정의한 볼륨은 spec.containers 항목에서 참조해 사용하고 있다.
- spec.containers.volumeMounts: volumes 항목에서 정의된 볼륨을 컨테이너 내부의 어떤 디렉터리에 마운트할 것인지 명시한다. 위 예시에서는 `/etc/config` 디렉터리에 Configmap의 값이 담긴 파일이 마운트될 것이다.

위 YAML 파일로 파드를 생성한 뒤, 파드의 `/etc/config` 디렉터리를 조회해 보겠다.

```bash
$ kubectl apply -f volume-mount-configmap.yaml
pod/configmap-volume-pod created

$ kubectl exec configmap-volume-pod -- ls /etc/config
container
k8s

$ kubectl exec configmap-volume-pod -- cat /etc/config/k8s
kubernetes
```

Configmap에 저장돼 있던 두 개의 key-value data, 즉 container와 k8s라는 키 이름이 파일로 존재하고 있다. 여기서 알아둬야 할 것은 Configmap의 모든 key-value data가 마운트됐으며, 파일 이름은 키의 이름과 같다는 것이다.

















































