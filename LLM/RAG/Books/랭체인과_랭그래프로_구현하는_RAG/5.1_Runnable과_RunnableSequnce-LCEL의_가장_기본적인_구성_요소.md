Runnable과 RunnableSequence-LCEL의 가장 기본적인 구성 요소(5.1)

LCEL의 가장 기본적인 구현은 Prompt template, Chat model, Output parser의 세 가지를 연결하는 것

```python
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

prompt = ChatPromptTemplate.from_messages(
    [
        ("system", "사용자가 입력한 요리의 레시피를 생각해 주세요."),
        ("human", "{dish}"),
    ]
)      

model = ChatOpenAI(model="gpt-4o-mini", temperature=0)

output_parser = StrOutputParser()
```

prompt, model, `output_parser` 를 순서대로 invoke 하는 코드는 다음과 같다.

```python
prompt_value = prompt.invoke({"dish": "카레"})
ai_message = model.invoke(prompt_value)
output = output_parser.invoke(ai_message)

print(output)
```

이렇게 순서대로 실행할 수 있지만, LCEL에서 이들을 `|`로 연결한 후 실행한다. 사실, ChatPromptTemplate, ChatOpenAI, StrOutputParser 는 모두 LangChain의 `Runnable` 이라는 추상 기본 클래스를 상속받고 있다. Runnable 을 `|` 로 연결하면 `RunnableSequence`가 된다. RunnableSequence도 Runnable의 일종이다.

RunnableSequence를 invoke하면 연결된 Runnable이 순서대로 invoke 된다.

```python
chain = prompt | model | output_parser
output = chain.invoke({"dish": "카레"})
```

# Runnable의 실행 방법-invoke, stream, batch

Runnable의 실행 방법으로는 invoke 외에도 stream, batch가 있다.  

Runnable을 스트리밍으로 실행하려면 stream 메서드를 사용한다.

```python
chain = prompt | model | output_parser

for chunk in chain.stream({"dish": "카레"}):
    print(chain, end="", flush=True)
```

또한, batch 메서드를 사용하면 여러 입력을 한꺼번에 처리할 수 있다.

```python
chain = prompt | model | output_parser

outputs = chain.batch([{"dish": "카레"}, {"dish": "우동"}])
print(outputs)
```

# LCEL은 어떻게 구현됐는가

LCEL은 LangChain의 각종 모듈이 상속 받는 Runnable 클래스를 통해 구현된다. LangChain(langchain-core)의 소스 코드에서 Runnable은 추상 기본 클래스(ABC)로 정의돼 있다.

```python
class Runnable(Generic[Input, Output], ABC):
    def __or__(self,
            other: Union[Runnable[Any, Other],
                    Callable[[Any], Other],
                    Callable[[Iterator[Any]], Iterator[Other]],
                    Mapping[str, Union[Runnable[Any, Other], Callable[[Any], Other], Any]],
                ],
        ) -> RunnableSerializable[Input, Other]:
        """Compose this runnable with another object to create a RunnableSequence."""
        return RunnableSequence(first=self, last=coerce_to_runnable(other))
    
    def __ror__(self,
            other: Union
        )
```


























