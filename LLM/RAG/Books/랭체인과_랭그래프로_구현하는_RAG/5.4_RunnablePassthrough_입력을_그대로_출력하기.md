RunnablePassthrough - 입력을 그대로 출력하기(5.4)

RunnableParallel을 사용할 때 그 요소 중 일부에서 입력값을 그대로 출력하고 싶은 경우가 있다. 입력을 그대로 출력하기 위해 사용할 수 있는 것이 RunnablePassthrough이다.

RunnablePassthrough를 사용하는 간단한 RAG의 Chain을 구현해보겠다. RAG의 전형적인 구현은 문서를 벡터 데이터베이스에 저장해 벡터를 검색하지만, 여기서는 더 간단하게 웹 검색으로 구현하겠다.

웹 검색에는 'Tavily'를 사용한다. Tavily API 키를 받고 환경 변수로 설정한다.

```python
import os
from google.colab import userdata

os.environ["TAVILY_API_KEY"] = userdata.get("TAVILY_API_KEY")
```

```bash
pip install tavily-python==0.5.0
```

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

prompt = ChatPromptTemplate.fromt_template('''
다음 문맥만을 고려하여 질문에 답하세요.
문맥: """{context}"""
질문: {question}
''')
model = ChatOpenAI(model_name="gpt-4o-mini", temperature=0)
```

Tavily를 LangChain의 Retriever로 사용하기 위한 TavilySearchAPIRetriever를 준비한다.

```python
from langchain_community.retrievers import TavilySearchAPIRetriever

retriever = TavilySearchAPIRetriever(k=3)
```

TavilySearchAPIRetriever의 k 매개변수에 검색한 결과 수를 지정한다.

```python
from langchain_core.runnables import RunnablePassthrough

chain = (
    {"context": retriever, "question": RunnablePassthrough()}  # RunnableParallel로 자동 변환됨
    | prompt
    | model
    | StrOutputParser()
)
output = chain.invoke("서울의 현재 날씨는?")
print(output)
```

RunnablePassthrough는 입력을 그대로 출력한다. prompt의 입력 중 "question"에는 "서울의 현재 날씨는?"이라는 문자열이 그대로 들어간다. 반면, prompt의 입력 중 "context"에는 retriever의 실행 결과인 검색 결과 목록이 들어간다.

이처럼 RunnableParallel의 출력 중 하나로 입력값을 그대로 사용하고 싶을때 사용한다.

---

# assign-RunnableParallel의 출력에 값 추가하기

RAG Chain에서는 LLM이 생성한 최종 답변만 Chain 전체의 출력이 된다. 그러나 retriever의 검색 결과도 Chain 전체의 출력에 포함하고 싶은 경우가 많다. 이때 사용할 수 있는 것이 RunnablePassthrough의 assign이라는 클래스 메서드이다.

```python
import pprint

chain = {
    "question": RunnablePassthrough(),
    "context": retriever,
} | RunnablePassthrough.assign(
    answer=prompt | model | StrOutputParser()
)
output = chain.invoke("서울의 현재 날씨는?")
pprint.pprint(output)
```

```
{'answer': '서울의 현재 날씨는...',
'context': [Document(metadata={'title': '서울특별시, 서울시 현재 날씨...', 'source': 'https:...', 'score': 0.843}), ...]
```

RunnablePassthrough.assign 부분에서 RunnableParallel의 실행 결과를 츄지한 채 'answer'를 추가한 dict를 출력한 것이다.

참고로 assign은 RunnablePassthrough의 클래스 메서드 외에도 Runnable의 인스턴스 메서드로도 제공된다.

```python
chain = RunnableParallel({
    "question": RunnablePassthrough(),
    "context": retriever,
}).assign(answer=prompt | model | StrOutputParser())
```

이처럼 assign을 사용하면 context와 같은 Chain의 중간 값을 Chain의 최종 출력에 포함할 수 있다. 따라서 프롬프트를 채운 결과를 화면에 표시하고 싶은 경우 등 Chain의 중간 값을 UI에 표시하고 싶을때도 assign이 유용한다.

