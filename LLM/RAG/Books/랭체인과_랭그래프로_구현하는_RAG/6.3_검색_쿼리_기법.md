검색 쿼리 기법(6.3)

# HyDE(Hypothetical Document Embeddings)

단순한 RAG 구성에서는 사용자의 질문에 대한 임베딩 벡터의 유사도가 높은 문서를 검색한다. 그러나 실제로 검색하고자 하는 것은 질문과 유사한 문서가 아니라 답변과 유사한 문서이다. 이를 위해 HyDE(Hypothetical Document Embeddings)라는 기법이 있다.

HyDE에서는 사용자의 질문에 대해 LLM에 가상의 답변을 추론하게 하고, 그 출력을 임베딩 벡터의 유사도 검색에 사용한다.

먼저 가상 답변을 생성하는 Chain을 구현한다.

```python
hypothetical_prompt = ChatPromptTemplate.from_template("""
다음 질문에 한 문장으로 답하세요.

질문: {question}
""")

hypothetical_chain = hypothetical_prompt | model | StrOutputParser()
```

다음으로 가상의 답변을 생성하는 Chain을 사용한 RAG의 Chain을 구현한다.

```python
hyde_rag_chain = {
    "question": RunnablePassthrough(),
    "context": hypothetical_chain | retriever,  # 가상의 답변을 생성하는 Chain의 출력을 retriever에 전달
} | prompt | model | StrOutputParser()

hyde_rag_chain.invoke("LangChain의 개요를 알려줘")
```

위 코드를 실행하고 LangSmith에서 트레이스를 확인하면 LLM이 생성한 가상의 답변을 기반으로 검색이 이뤄진 것을 확인할 수 있다.

HyDE는 사용자의 질문보다 가상의 답변이 임베딩 벡터의 유사도 검색에 더 적합하다는 가정에 기반한 기법이다. 따라서 HyDE가 특히 효과적인 것은 LLM이 가상의 답변을 추론하기 쉬운 경우라고 볼 수 있다.

# 복수 검색 쿼리 생성

앞의 예시에서는 가상의 답변을 하나만 생성해 검색 쿼리로 사용했다. LLM에 여러 검색 쿼리를 상셩하게 하는 방법도 있다.

```python
from pydantic import BaseModel, Field

class QueryGenerationOutput(BaseModel):
    queries: list[str] = Field(..., description="검색 쿼리 목록")

query_generation_prompt = ChatPromptTemplate.from_template("""\
질문에 대해 벡터 데이터베이스에서 관련 문서를 검색하기 위한 3개의 서로 다른 검색 쿼리를 생성하세요.
거리 기반 유사성 검색의 한계를 극복하기 위해 사용자의 질문에 대해 여려 관점을 제공하는 것이 목표입니다.

질문: {question}
""")

query_generation_chain = (
    query_generation_prompt
    | model.with_structured_output(QueryGenerationOutput)
    | (lambda x: x.queries)
)
```

이 `query_generation_chain`은 검색 쿼리 문자열의 리스트를 출력한다. `query_generation_chain`의 출력 기반으로 검색하는 RAG의 Chain을 생성해 실행하는 코드는 다음과 같다.

```python
multi_query_rag_chain = {
    "question": RunnablePassthrough(),
    "context": query_generation_chain | retriever.map(),
} | prompt | model | StrOutputParser()

multi_query_rag_chain.invoke("LangChain의 개요를 알려줘")
```

위 코드의 retriever.map()에서는 list[str]을 받아 list[list[Document]]를 반환하도록 변환한다. map은 LangChain의 Runnable이 제공하는 메서드 중 하나로, 원래 Runnable의 인자와 반환값을 리스트화하는 메서드이다.

지금까지 검색 쿼리 기법으로 사용자의 질문을 기반으로 LLM으로 검색 쿼리를 생성하는 예를 2가지 구현해보았다.  
검색 쿼리를 생성하는 기법으로는 이 외에도 원래 질문을 추상도가 높은 질문으로 바꾸는 Step-Back Prompting 등도 있다.

